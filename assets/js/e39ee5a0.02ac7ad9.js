"use strict";(self.webpackChunktailcall_run=self.webpackChunktailcall_run||[]).push([[833],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},h="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),h=p(n),d=r,m=h["".concat(l,".").concat(d)]||h[d]||c[d]||i;return n?a.createElement(m,s(s({ref:t},u),{},{components:n})):a.createElement(m,s({ref:t},u))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,s=new Array(i);s[0]=d;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o[h]="string"==typeof e?e:r,s[1]=o;for(var p=2;p<i;p++)s[p]=n[p];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},6345:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>c,frontMatter:()=>i,metadata:()=>o,toc:()=>p});var a=n(7462),r=(n(7294),n(3905));const i={title:"N + 1 Problem"},s=void 0,o={unversionedId:"advanced/n+1",id:"advanced/n+1",title:"N + 1 Problem",description:"The N+1 problem is a pervasive and critical issue in application development that occurs when an application ends up issuing a large number of downstream requests, for a single request from upstream. Let's understand with an example:",source:"@site/docs/advanced/n+1.md",sourceDirName:"advanced",slug:"/advanced/n+1",permalink:"/docs/advanced/n+1",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/advanced/n+1.md",tags:[],version:"current",frontMatter:{title:"N + 1 Problem"},sidebar:"tutorialSidebar",previous:{title:"Quick Start",permalink:"/docs/intro/quickstart"},next:{title:"Operators",permalink:"/docs/advanced/operators"}},l={},p=[{value:"Scenario",id:"scenario",level:2},{value:"Fetching Posts",id:"fetching-posts",level:3},{value:"Fetching Users",id:"fetching-users",level:3},{value:"The N+1 Problem",id:"the-n1-problem",level:2},{value:"Using the CLI",id:"using-the-cli",level:2},{value:"Jsonplaceholder Example",id:"jsonplaceholder-example",level:3},{value:"Running the TailCall CLI",id:"running-the-tailcall-cli",level:3},{value:"Interpreting the Output",id:"interpreting-the-output",level:3},{value:"Solving Using Batching",id:"solving-using-batching",level:2},{value:"Understanding the Update",id:"understanding-the-update",level:3}],u={toc:p},h="wrapper";function c(e){let{components:t,...n}=e;return(0,r.kt)(h,(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"The ",(0,r.kt)("strong",{parentName:"p"},"N+1 problem")," is a pervasive and critical issue in application development that occurs when an application ends up issuing a large number of downstream requests, for a single request from upstream. Let's understand with an example:"),(0,r.kt)("h2",{id:"scenario"},"Scenario"),(0,r.kt)("p",null,"Consider we're developing a feature that involves consuming data from the ",(0,r.kt)("a",{parentName:"p",href:"https://jsonplaceholder.typicode.com"},"JSON Placeholder API"),". The feature requires fetching posts and the details of the authors of these posts."),(0,r.kt)("p",null,"Here's an illustration of how this might typically be implemented:"),(0,r.kt)("h3",{id:"fetching-posts"},"Fetching Posts"),(0,r.kt)("p",null,"First, we send a request to retrieve all posts:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-markdown"},"curl https://jsonplaceholder.typicode.com/posts\n")),(0,r.kt)("p",null,"The above request fetches a list of posts from the API, each of which includes a ",(0,r.kt)("inlineCode",{parentName:"p"},"userId")," field indicating the author of the post."),(0,r.kt)("h3",{id:"fetching-users"},"Fetching Users"),(0,r.kt)("p",null,"Then, for each post, we need to get the author's details. A request for a specific user might look like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-markdown"},"curl https://jsonplaceholder.typicode.com/users/1\n")),(0,r.kt)("p",null,"If we received 100 posts from our first request, we would then make 100 more requests to get each post's author details, resulting in a total of 101 requests."),(0,r.kt)("h2",{id:"the-n1-problem"},"The N+1 Problem"),(0,r.kt)("p",null,"The N+1 problem, demonstrated using the JSON Placeholder API, refers to the issue where an initial API request generates multiple additional requests. For instance, acquiring 100 posts and then making another request for each post's author details culminates in 101 total requests."),(0,r.kt)("p",null,"In real-world applications with thousands of posts and users, this problem intensifies. Each user request can yield hundreds or thousands of additional server requests, stressing server resources, and leading to slower response times, higher server costs, and a degraded user experience. This situation can even lead to server downtime due to the high volume of requests, impacting service availability. Therefore, it's crucial to address the N+1 problem during the design and development of applications involving numerous API requests. Solutions to this issue will be discussed in subsequent sections."),(0,r.kt)("h2",{id:"using-the-cli"},"Using the CLI"),(0,r.kt)("p",null,"The TailCall CLI is a potent tool for developers, helping identify N+1 issues in GraphQL applications even before any requests are made or configurations are published on production. This proactive approach allows for potential issues to be mitigated right from the development stage."),(0,r.kt)("p",null,"Before diving into the usage, ensure you have familiarized yourself with the basics of the TailCall CLI. If you haven't already, please refer to the ",(0,r.kt)("a",{parentName:"p",href:"/docs/intro/quickstart"},"Quick Start")," guide, which will walk you through the setup process and help you understand the key commands."),(0,r.kt)("h3",{id:"jsonplaceholder-example"},"Jsonplaceholder Example"),(0,r.kt)("p",null,"Here is a sample ",(0,r.kt)("inlineCode",{parentName:"p"},".graphql")," file that we'll be examining:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-graphql",metastring:"showLineNumbers",showLineNumbers:!0},'schema @server(baseURL: "http://jsonplaceholder.typicode.com") {\n  query: Query\n}\n\ntype Query {\n  posts: [Post] @http(path: "/posts")\n}\n\ntype User {\n  id: Int!\n  name: String!\n  username: String!\n  email: String!\n  phone: String\n  website: String\n}\n\ntype Post {\n  id: Int!\n  userId: Int!\n  title: String!\n  body: String!\n  user: User @http(path: "/users/{{value.userId}}")\n}\n')),(0,r.kt)("p",null,"This schema allows clients to fetch a list of posts, with each post including its associated user data. However, as currently defined, it suffers from the N+1 problem: each post will trigger an additional request to fetch its associated user data."),(0,r.kt)("p",null,"We will demonstrate how to identify this issue using the TailCall CLI in the next section."),(0,r.kt)("h3",{id:"running-the-tailcall-cli"},"Running the TailCall CLI"),(0,r.kt)("p",null,"With the ",(0,r.kt)("inlineCode",{parentName:"p"},"check")," command, TailCall CLI can assist you in identifying potential N+1 issues in a GraphQL file:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"\u276f tc check ./jsonplaceholder.graphql\n")),(0,r.kt)("p",null,"For a deeper understanding of these N+1 issues, you can use the ",(0,r.kt)("inlineCode",{parentName:"p"},"--n-plus-one-queries")," parameter:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"\u276f tc check ./jsonplaceholder.graphql --n-plus-one-queries\n")),(0,r.kt)("p",null,"This parameter uncovers the minimal query that can trigger an N+1 problem."),(0,r.kt)("h3",{id:"interpreting-the-output"},"Interpreting the Output"),(0,r.kt)("p",null,"The output from the ",(0,r.kt)("inlineCode",{parentName:"p"},"check")," command zeroes in on the ",(0,r.kt)("inlineCode",{parentName:"p"},"N + 1")," section. Here's an example output:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"\u276f tc-dev check  ./jsonplaceholder.graphql --n-plus-one-queries\nNo errors found.\nDigest:    6147865213be868d666e4bb6793183c43a32668b03f97c4eeaa2c07792e9be71\nEndpoints: 2\nUnsafe:    0\n# highlight-start\nN + 1:     1\n  query { posts { user } }\n# highlight-end\n")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"N + 1: 1")," line tells you that the TailCall CLI has detected one potential N+1 issue. The next line, ",(0,r.kt)("inlineCode",{parentName:"p"},"query { posts { user } }"),", represents the minimal query that could lead to an N+1 problem. It illustrates that within the ",(0,r.kt)("inlineCode",{parentName:"p"},"posts")," query, each post is triggering an additional request to fetch its associated ",(0,r.kt)("inlineCode",{parentName:"p"},"user")," data."),(0,r.kt)("p",null,"By using the ",(0,r.kt)("inlineCode",{parentName:"p"},"--n-plus-one-queries")," parameter with the ",(0,r.kt)("inlineCode",{parentName:"p"},"check")," command, you can identify potential N+1 problems and pinpoint the queries that can lead to such issues, allowing you to ensure efficient and performant GraphQL applications."),(0,r.kt)("h2",{id:"solving-using-batching"},"Solving Using Batching"),(0,r.kt)("p",null,"Batching is a vital optimization strategy that allows us to group multiple requests into a single one, considerably reducing the total number of requests sent to the server. TailCall CLI offers this ability to mitigate the N+1 problem in a GraphQL context."),(0,r.kt)("p",null,"To enable this, you'll need to adjust the ",(0,r.kt)("inlineCode",{parentName:"p"},"@http")," directive on ",(0,r.kt)("inlineCode",{parentName:"p"},"Post.user")," within your GraphQL schema:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-graphql",metastring:"showLineNumbers",showLineNumbers:!0},'type Post {\n  id: Int!\n  userId: Int!\n  title: String!\n  body: String!\n  user: User\n    @http(\n      path: "/users"\n      # highlight-start\n      query: {id: "{{parent.value.userId}}"}\n      matchPath: ["id"]\n      matchKey: "userId"\n      # highlight-end\n    )\n}\n')),(0,r.kt)("h3",{id:"understanding-the-update"},"Understanding the Update"),(0,r.kt)("p",null,"This adjustment to the ",(0,r.kt)("inlineCode",{parentName:"p"},"@http")," directive includes three significant parameters: ",(0,r.kt)("inlineCode",{parentName:"p"},"query"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"matchPath"),", and ",(0,r.kt)("inlineCode",{parentName:"p"},"matchKey"),"."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},'query: { id: "{{parent.value.userId}}" }'),": Here, TailCall CLI is instructed to generate a URL where the user id aligns with the ",(0,r.kt)("inlineCode",{parentName:"p"},"userId")," from the parent ",(0,r.kt)("inlineCode",{parentName:"p"},"Post"),". For a batch of posts, the CLI compiles a single URL, such as ",(0,r.kt)("inlineCode",{parentName:"p"},"/users?id=1&id=2&id=3...id=10"),", consolidating multiple requests into one.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},'matchPath: ["id"]'),": This parameter instructs the system to convert the list of responses into a map internally, using the user's ",(0,r.kt)("inlineCode",{parentName:"p"},"id")," as the unique key. In essence, it allows the system to differentiate each user value in the response list.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},'matchKey: "userId"'),": This parameter matches the ",(0,r.kt)("inlineCode",{parentName:"p"},"userId")," from the ",(0,r.kt)("inlineCode",{parentName:"p"},"Post")," object to the user data in the batched request response. This correlation is crucial for associating the ",(0,r.kt)("inlineCode",{parentName:"p"},"Post")," to its relevant ",(0,r.kt)("inlineCode",{parentName:"p"},"User"),"."))),(0,r.kt)("p",null,"By using this approach, you can reduce the number of requests from 101 (for 100 posts plus one initial request for the post list) to just 2. This significant optimization effectively handles the N+1 problem, thereby enhancing your application's efficiency and user experience."))}c.isMDXComponent=!0}}]);